package com.example.main;

import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;
import android.Manifest;
import android.annotation.SuppressLint;
import android.app.Dialog;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.graphics.Color;
import android.graphics.drawable.ColorDrawable;
import android.os.Build;
import android.os.Bundle;
import android.view.Window;
import android.widget.Button;
import android.widget.TextView;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.select.Elements;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;

public class mainactivity extends AppCompatActivity {

    private static int REQUEST_ACCESS_FINE_LOCATION = 1000;
    Dialog Shuttledialog;
    TextView textTime,textTemp;
    String url = "https://weather.naver.com/today";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {

            int permissionCheck = ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION);

            if(permissionCheck == PackageManager.PERMISSION_DENIED){

                // 권한 없음
                ActivityCompat.requestPermissions(this,
                        new String[]{Manifest.permission.ACCESS_FINE_LOCATION},
                        REQUEST_ACCESS_FINE_LOCATION);
            } else{
                // ACCESS_FINE_LOCATION 에 대한 권한이 이미 있음.
            }
        }

// OS가 Marshmallow 이전일 경우 권한체크를 하지 않는다.
        else{

        }
        Shuttledialog = new Dialog(mainactivity.this);
        Shuttledialog.requestWindowFeature(Window.FEATURE_NO_TITLE);
        Shuttledialog.getWindow().setBackgroundDrawable(new ColorDrawable(Color.TRANSPARENT));
        Shuttledialog.setContentView(R.layout.activity_main_shuttle_popup); // main_shuttle_popup 팝업창


        Button btn1 = findViewById(R.id.btn_shuttle); // 셔틀버스 버튼
        Button btn2 = findViewById(R.id.btn_tonghak); // 통학버스 버튼
        Button btn3 = findViewById(R.id.btn_call);    // 콜벤버튼

        textTime =  findViewById(R.id.text_Time); // 시간 웹 크롤링
        textTemp = findViewById(R.id.text_Temp);  // 위치 온도 웹 크롤링

        (new Thread(() -> {
            textTime.setText("인터넷에 연결되어있지 않습니다.");
            while (true){
                try {
                    Thread.sleep(300);
                    Document doc = Jsoup.connect(url).get();
                    Elements temp = doc.select(".current");
                    Elements location = doc.select(".location_name");
                    Elements ultraviolet_ray = doc.select(".level5_4");
                    if (!temp.isEmpty() && !location.isEmpty() && !ultraviolet_ray.isEmpty()) {
                        String temp_val = temp.get(0).text().substring(5);
                        String location_val = location.get(0).text();
                        String ultraviolet_ray_val = ultraviolet_ray.get(0).text();
                        runOnUiThread(() -> {
                                textTime.setText(getCurrentTime());
                                textTemp.setText(location_val + "\n\t온도 : " + temp_val + "\n\t자외선 :  " + ultraviolet_ray_val);

                                textTime.setText("인터넷에 연결되어있지 않습니다.");
                        });
                    }

                } catch (InterruptedException | IOException e )
                {
                    new Thread(() -> runOnUiThread(() -> {
                        textTime.setText("인터넷에 연결되어있지 않습니다.");
                        textTemp.setText("");
                    })).start();
                }
            }
        })).start();


        btn1.setOnClickListener(view -> showShuttledialog());
        btn2.setOnClickListener(v -> {

        });
        
        btn3.setOnClickListener(v -> {
            Intent it = new Intent(mainactivity.this, crawling.class);
            startActivity(it);
        });

    }

    public String getCurrentTime(){

        long now = System.currentTimeMillis();
        Date mDate = new Date(now);
        @SuppressLint("SimpleDateFormat") SimpleDateFormat simpleDate = new SimpleDateFormat("yyyy년 MM월 dd일 \nhh시 mm분 ss초");
        return simpleDate.format(mDate);
    }

    public void showShuttledialog(){
        Shuttledialog.show();

        Button btn_wd = Shuttledialog.findViewById(R.id.btn_weekday);
        Button btn_we = Shuttledialog.findViewById(R.id.btn_weekend);
        Button btn_ho = Shuttledialog.findViewById(R.id.btn_holiday);

        btn_wd.setOnClickListener(view -> {
            Intent it = new Intent(mainactivity.this, shuttle_boarding_point.class);
            it.putExtra("text","평일");
            startActivity(it);
            Shuttledialog.dismiss();
        });
        btn_we.setOnClickListener(view -> {
            Intent it = new Intent(mainactivity.this, shuttle_boarding_point.class);
            it.putExtra("text","공휴일");
            startActivity(it);
            Shuttledialog.dismiss();
        });
        btn_ho.setOnClickListener(view -> {
            Intent it = new Intent(mainactivity.this, shuttle_boarding_point.class);
            it.putExtra("text","일요일");
            startActivity(it);
            Shuttledialog.dismiss();
        });
        // 버튼 클릭 시 동작 기능
    }
}

